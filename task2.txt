Задание 2:

Задание: Реализовать счетчик вызова скрипта. Было принято решение, хранить данные в файле.

<?php 

file_put_contents("./counter.txt", file_get_contents("./counter.txt") + 1);

Вопрос: Какие проблемы имеет данные подход? Как вы их можете решить? 
(Нельзя использовать другие технологии)

Дополнительный вопрос: Через некоторое время нагрузка на сервер значительно выросла. Какие проблемы вы видите? Как вы их можете решить? 
Если бы вы могли выбрать другую технологию, то какую и почему?



Какие проблемы имеет данные подход?
file_put_contents - идентична последовательным успешным вызовам функций fopen(), fwrite() и fclose()
и есть вероятность того что между вызовами fopen() и fwrite() вклинится еще file_put_contents,
если простыми словами, представим что 2 процесса получили одинаковое значение счетчика, один из процессов сохранил новый счетчик в файл, а другой процесс не учел новое изменение.

Помимо этого есть еще ряд проблем:
- Файл может быть удален
- Могут быть изменены права на доступ к файлу, и файл нельзя будет изменить или прочитать
- В файл можно сохранить строку, что поломает счетчик



Как вы их можете решить?
в функции file_put_contents выставить flags LOCK_EX
LOCK_EX - между вызовами fopen() и fwrite() сделает вызов функции flock()

то есть сделать так:
file_put_contents("./counter.txt", file_get_contents("./counter.txt") + 1, LOCK_EX);


- Включить блокировку файла на запись LOCK_EX
в функции file_put_contents выставить flags LOCK_EX
LOCK_EX - между вызовами fopen() и fwrite() сделает вызов функции flock()
то есть сделать так: file_put_contents("./counter.txt", file_get_contents("./counter.txt") + 1, LOCK_EX);
- Проверка на существование файла
- Проверка что файл доступен на чтение и запись
- Валидация данных перед сохраненем, после прочтения и привести к числу


Через некоторое время нагрузка на сервер значительно выросла. Какие проблемы вы видите?
Из за блокировки процессы будут ждать когда файл освободится


Как вы их можете решить? 
Так как мы не ожидаем ответа от счетчика, то можно сделать запускать счетчик асинхронно



Если бы вы могли выбрать другую технологию, то какую и почему?
Как вариант рассмотрел бы Redis, почему:
- Есть счетчик из коробки, https://redis.io/commands/incr
- Атомарный, не нужны блокировки
- Быстрый, так как работае в памяти
- Умеет сохранять данные на диск

минус, в том, что есть вероятность потерять данные